<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Grabadora de Audios</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f2f2f2;
      padding: 30px;
    }
    h1 {
      color: #333;
    }
    button {
      background: #4CAF50;
      border: none;
      color: white;
      padding: 10px 16px;
      margin: 5px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.3s;
    }
    button:hover {
      opacity: 0.9;
    }
    .delete-btn {
      background: #e74c3c;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
      color: #555;
    }
    audio {
      margin-top: 15px;
      display: block;
      width: 100%;
    }
    #list {
      margin-top: 25px;
      text-align: left;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    .item span {
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>ğŸ™ï¸ Grabadora de Audios</h1>
  
  <button id="startBtn">â–¶ï¸ Iniciar GrabaciÃ³n</button>
  <button id="stopBtn" disabled>â¹ï¸ Detener GrabaciÃ³n</button>
  <button id="playRandomBtn">ğŸ”€ Reproducir Aleatorio</button>
  
  <div id="status">Listo para grabar...</div>
  
  <audio id="player" controls></audio>
  
  <h2>ğŸ“‚ Mis Audios</h2>
  <div id="list"></div>
  
  <script>
    let mediaRecorder;
    let audioChunks = [];
    let recordings = []; // Guardamos blobs
    const maxDuration = 15000; // 15 segundos

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const playRandomBtn = document.getElementById('playRandomBtn');
    const statusEl = document.getElementById('status');
    const player = document.getElementById('player');
    const listEl = document.getElementById('list');

    // Cargar audios guardados de localStorage
    if(localStorage.getItem("audios")) {
      recordings = JSON.parse(localStorage.getItem("audios")).map(b64 => b64toBlob(b64));
      renderList();
    }

    startBtn.addEventListener('click', async () => {
      let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        recordings.push(blob);
        saveRecordings();
        renderList();
        statusEl.textContent = "âœ… Audio guardado correctamente";
      };

      mediaRecorder.start();
      statusEl.textContent = "âºï¸ Grabando... (mÃ¡x. 15s)";
      startBtn.disabled = true;
      stopBtn.disabled = false;

      // Detener automÃ¡ticamente a los 15s
      setTimeout(() => {
        if (mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          startBtn.disabled = false;
          stopBtn.disabled = true;
        }
      }, maxDuration);
    });

    stopBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    });

    playRandomBtn.addEventListener('click', () => {
      if (recordings.length === 0) {
        statusEl.textContent = "âš ï¸ No hay audios guardados aÃºn.";
        return;
      }
      const randomIndex = Math.floor(Math.random() * recordings.length);
      playAudio(recordings[randomIndex]);
      statusEl.textContent = `ğŸµ Reproduciendo audio #${randomIndex + 1}`;
    });

    // Guardar audios en localStorage
    function saveRecordings() {
      const b64Audios = recordings.map(blob => blobToBase64(blob));
      Promise.all(b64Audios).then(arr => {
        localStorage.setItem("audios", JSON.stringify(arr));
      });
    }

    // Renderizar lista de audios
    function renderList() {
      listEl.innerHTML = "";
      recordings.forEach((blob, index) => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <span>Audio ${index + 1}</span>
          <div>
            <button onclick="playAudio(recordings[${index}])">ğŸµ Reproducir</button>
            <button class="delete-btn" onclick="deleteAudio(${index})">ğŸ—‘ï¸ Eliminar</button>
          </div>
        `;
        listEl.appendChild(div);
      });
    }

    // Reproducir audio
    function playAudio(blob) {
      const url = URL.createObjectURL(blob);
      player.src = url;
      player.play();
    }

    // Eliminar audio
    function deleteAudio(index) {
      recordings.splice(index, 1);
      saveRecordings();
      renderList();
      statusEl.textContent = "ğŸ—‘ï¸ Audio eliminado.";
    }

    // Convertir Blob â†’ Base64
    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(",")[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // Convertir Base64 â†’ Blob
    function b64toBlob(b64Data) {
      const byteCharacters = atob(b64Data);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], { type: 'audio/webm' });
    }
  </script>
</body>
</html>
