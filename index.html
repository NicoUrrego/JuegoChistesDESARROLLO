<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Grabadora de Audios</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f2f2f2;
      padding: 30px;
    }
    h1 {
      color: #333;
    }
    button {
      background: #4CAF50;
      border: none;
      color: white;
      padding: 12px 20px;
      margin: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: 0.3s;
    }
    button:hover {
      background: #45a049;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
      color: #555;
    }
    audio {
      margin-top: 15px;
      display: block;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>üéôÔ∏è Grabadora de Audios</h1>
  
  <button id="startBtn">‚ñ∂Ô∏è Iniciar Grabaci√≥n</button>
  <button id="stopBtn" disabled>‚èπÔ∏è Detener Grabaci√≥n</button>
  <button id="playRandomBtn">üîÄ Reproducir Aleatorio</button>
  
  <div id="status">Listo para grabar...</div>
  
  <audio id="player" controls></audio>
  
  <script>
    let mediaRecorder;
    let audioChunks = [];
    let recordings = []; // Guardaremos los blobs en memoria
    const maxDuration = 15000; // 15 segundos

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const playRandomBtn = document.getElementById('playRandomBtn');
    const statusEl = document.getElementById('status');
    const player = document.getElementById('player');

    // Cargar audios guardados de localStorage
    if(localStorage.getItem("audios")) {
      recordings = JSON.parse(localStorage.getItem("audios")).map(b64 => b64toBlob(b64));
    }

    startBtn.addEventListener('click', async () => {
      let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        recordings.push(blob);
        saveRecordings();
        statusEl.textContent = "‚úÖ Audio guardado correctamente";
      };

      mediaRecorder.start();
      statusEl.textContent = "‚è∫Ô∏è Grabando... (m√°x. 15s)";
      startBtn.disabled = true;
      stopBtn.disabled = false;

      // Detener autom√°ticamente a los 15s
      setTimeout(() => {
        if (mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          startBtn.disabled = false;
          stopBtn.disabled = true;
        }
      }, maxDuration);
    });

    stopBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    });

    playRandomBtn.addEventListener('click', () => {
      if (recordings.length === 0) {
        statusEl.textContent = "‚ö†Ô∏è No hay audios guardados a√∫n.";
        return;
      }
      const randomIndex = Math.floor(Math.random() * recordings.length);
      const blob = recordings[randomIndex];
      const url = URL.createObjectURL(blob);
      player.src = url;
      player.play();
      statusEl.textContent = üéµ Reproduciendo audio #${randomIndex + 1};
    });

    // Funci√≥n para guardar en localStorage
    function saveRecordings() {
      const b64Audios = recordings.map(blob => blobToBase64(blob));
      Promise.all(b64Audios).then(arr => {
        localStorage.setItem("audios", JSON.stringify(arr));
      });
    }

    // Convertir Blob ‚Üí Base64
    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(",")[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // Convertir Base64 ‚Üí Blob
    function b64toBlob(b64Data) {
      const byteCharacters = atob(b64Data);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], { type: 'audio/webm' });
    }
  </script>
</body>
</html>
